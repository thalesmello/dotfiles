#!/usr/bin/env fish

set sock "/tmp/nvim-singleton.sock"
set panefile "/tmp/nvim-singleton.tmuxpane"


if test (count $argv) -gt 0
    argparse -i focus -- $argv

    if not test -S "$sock"; or not nvim --server "$sock" --remote-expr "1" &>/dev/null
        echo "Error: server not started" >&2
        return 1
    end

    test (count $argv) -gt 0
    and nvim --server "$sock" $argv

    if not test -f "$panefile"; or not set -q _flag_focus
        return
    else if test -n "$TMUX"
        tmux select-pane -t (cat "$panefile")
    else if tmux list-sessions &>/dev/null
        tmux select-pane -t (cat "$panefile")
    end
else
    if test -S "$sock"; and nvim --server "$sock" --remote-expr "1" &>/dev/null
        echo "Error: server already started" >&2
        return 1
    end

    if test -n "$TMUX"
        echo "$TMUX_PANE" > "$panefile"
    end

    exec nvim --listen "$sock" $argv
end

